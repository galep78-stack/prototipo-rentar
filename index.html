<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent.Ar - Prototipo Funcional Completo (Definitivo)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'primary-dark': '#061637', 'accent-blue': '#004aad', 'accent-cyan': '#5de0e6', 'secondary-dark': '#29007a' },
                    fontFamily: { heading: ['"Helvetica World Bold"', 'Arial', 'sans-serif'], sans: ['Arial', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #061637; color: white; min-height: 100vh; display: flex; flex-direction: column; font-family: Arial, sans-serif; }
        h1, h2, h3 { font-family: 'Helvetica World Bold', Arial, sans-serif; }
        main { flex-grow: 1; }
        .btn-secondary { border: 2px solid #5de0e6; color: #5de0e6; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: rgba(93, 224, 230, 0.1); }
        .logo-text-header { font-family: 'Helvetica World Bold', Arial, sans-serif; font-size: 1.75rem; font-weight: 700; color: white; }
        .role-selector { 
            border: 2px solid #ccc;
            transition: all 0.3s ease-in-out; 
            box-shadow: none;
        }
        .role-selector.active { 
            border-color: #004aad;
            background-color: rgba(0, 74, 173, 0.1);
            box-shadow: 0 0 15px rgba(93, 224, 230, 0.5);
        }
    </style>
</head>
<body>
    <header id="main-header" class="sticky top-0 z-50 bg-primary-dark shadow-xl"></header>
    <main class="container mx-auto px-4 py-8 flex-grow">
        <div id="content-view"></div>
    </main>
    <footer class="bg-primary-dark border-t border-accent-blue/20">
        <div class="container mx-auto px-4 pt-10 pb-6">
             <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-sm">
                 <div>
                     <a href="#" onclick="goToDashboard()" class="flex items-center">
                         <img src="logo-rentar.png" alt="Rent.Ar Logo" class="h-6 mr-2"> 
                         <span class="logo-text-header text-xl text-accent-cyan">Rent.Ar</span>
                     </a>
                     <p class="text-gray-400 font-sans mt-2">© 2025 Rent.Ar.</p>
                 </div>
                 <div>
                     <h5 class="font-bold text-accent-cyan mb-3 uppercase font-heading">Soporte</h5>
                     <ul class="space-y-2 font-sans">
                         <li><a href="mailto:contactorentar@gmail.com" class="text-gray-300 hover:text-accent-cyan transition">Contacto</a></li>
                     </ul>
                 </div>
                 <div>
                     <h5 class="font-bold text-accent-cyan mb-3 uppercase font-heading">Seguinos</h5>
                     <ul class="space-y-2 font-sans">
                         <li>
                             <a href="https://www.instagram.com/somosrent.ar" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-accent-cyan transition flex items-center">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="1.25em" height="1.25em" viewBox="0 0 24 24" fill="currentColor" class="mr-2">
                                     <path d="M7.8 2h8.4C17.9 2 19 3.1 19 4.6v8.8c0 1.5-1.1 2.6-2.8 2.6H7.8C6.1 16 5 14.9 5 13.4V4.6C5 3.1 6.1 2 7.8 2zm-.2 2a.6.6 0 0 0-.6.6v8.8a.6.6 0 0 0 .6.6h8.4a.6.6 0 0 0 .6-.6V4.6a.6.6 0 0 0-.6-.6H7.6zM12 7.5a4.5 4.5 0 1 0 0 9a4.5 4.5 0 0 0 0-9zm0 8a3.5 3.5 0 1 1 0-7a3.5 3.5 0 0 1 0 7zm5.5-8.5a1 1 0 1 0 0 2a1 1 0 0 0 0-2z"/>
                                 </svg>
                                 <span>@somosrentar</span>
                             </a>
                         </li>
                     </ul>
                 </div>
             </div>
             <div class="border-t border-accent-blue/20 mt-8 pt-6 col-span-2 md:col-span-4 text-center text-xs text-gray-500 font-sans">
                 <h6 class="font-bold text-gray-400 mb-2 uppercase">Aviso Legal</h6>
                 <p>Rent.ar es una plataforma que actúa como intermediario. No nos responsabilizamos por los acuerdos o transacciones entre las partes.</p>
             </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rent.Ar - Prototipo Funcional Completo (Definitivo)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 'primary-dark': '#061637', 'accent-blue': '#004aad', 'accent-cyan': '#5de0e6', 'secondary-dark': '#29007a' },
                    fontFamily: { heading: ['"Helvetica World Bold"', 'Arial', 'sans-serif'], sans: ['Arial', 'sans-serif'] }
                }
            }
        }
    </script>
    <style>
        body { background-color: #061637; color: white; min-height: 100vh; display: flex; flex-direction: column; font-family: Arial, sans-serif; }
        h1, h2, h3 { font-family: 'Helvetica World Bold', Arial, sans-serif; }
        main { flex-grow: 1; }
        .btn-secondary { border: 2px solid #5de0e6; color: #5de0e6; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: rgba(93, 224, 230, 0.1); }
        .logo-text-header { font-family: 'Helvetica World Bold', Arial, sans-serif; font-size: 1.75rem; font-weight: 700; color: white; }
        .role-selector { 
            border: 2px solid #ccc;
            transition: all 0.3s ease-in-out; 
            box-shadow: none;
        }
        .role-selector.active { 
            border-color: #004aad;
            background-color: rgba(0, 74, 173, 0.1);
            box-shadow: 0 0 15px rgba(93, 224, 230, 0.5);
        }
    </style>
</head>
<body>
    <header id="main-header" class="sticky top-0 z-50 bg-primary-dark shadow-xl"></header>
    <main class="container mx-auto px-4 py-8 flex-grow">
        <div id="content-view"></div>
    </main>
    <footer class="bg-primary-dark border-t border-accent-blue/20">
        <div class="container mx-auto px-4 pt-10 pb-6">
             <div class="grid grid-cols-2 md:grid-cols-4 gap-8 text-sm">
                 <div>
                     <a href="#" onclick="goToDashboard()" class="flex items-center">
                         <img src="logo-rentar.png" alt="Rent.Ar Logo" class="h-6 mr-2"> 
                         <span class="logo-text-header text-xl text-accent-cyan">Rent.Ar</span>
                     </a>
                     <p class="text-gray-400 font-sans mt-2">© 2025 Rent.Ar.</p>
                 </div>
                 <div>
                     <h5 class="font-bold text-accent-cyan mb-3 uppercase font-heading">Soporte</h5>
                     <ul class="space-y-2 font-sans">
                         <li><a href="mailto:contactorentar@gmail.com" class="text-gray-300 hover:text-accent-cyan transition">Contacto</a></li>
                     </ul>
                 </div>
                 <div>
                     <h5 class="font-bold text-accent-cyan mb-3 uppercase font-heading">Seguinos</h5>
                     <ul class="space-y-2 font-sans">
                         <li>
                             <a href="https://www.instagram.com/somosrent.ar" target="_blank" rel="noopener noreferrer" class="text-gray-300 hover:text-accent-cyan transition flex items-center">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="1.25em" height="1.25em" viewBox="0 0 24 24" fill="currentColor" class="mr-2">
                                     <path d="M7.8 2h8.4C17.9 2 19 3.1 19 4.6v8.8c0 1.5-1.1 2.6-2.8 2.6H7.8C6.1 16 5 14.9 5 13.4V4.6C5 3.1 6.1 2 7.8 2zm-.2 2a.6.6 0 0 0-.6.6v8.8a.6.6 0 0 0 .6.6h8.4a.6.6 0 0 0 .6-.6V4.6a.6.6 0 0 0-.6-.6H7.6zM12 7.5a4.5 4.5 0 1 0 0 9a4.5 4.5 0 0 0 0-9zm0 8a3.5 3.5 0 1 1 0-7a3.5 3.5 0 0 1 0 7zm5.5-8.5a1 1 0 1 0 0 2a1 1 0 0 0 0-2z"/>
                                 </svg>
                                 <span>@somosrentar</span>
                             </a>
                         </li>
                     </ul>
                 </div>
             </div>
             <div class="border-t border-accent-blue/20 mt-8 pt-6 col-span-2 md:col-span-4 text-center text-xs text-gray-500 font-sans">
                 <h6 class="font-bold text-gray-400 mb-2 uppercase">Aviso Legal</h6>
                 <p>Rent.ar es una plataforma que actúa como intermediario. No nos responsabilizamos por los acuerdos o transacciones entre las partes.</p>
             </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ==================================================================
        // == CÓDIGO FINAL Y ESTABLE (TODOS LOS CAMBIOS CONSOLIDADOS) ==
        // ==================================================================

        // VARIABLES GLOBALES
        let currentUser = null;
        let selectedRole = null;
        const contentView = document.getElementById('content-view');
        let isNavigating = false; // Flag para evitar navegaciones concurrentes
        let currentViewName = ''; // Guarda el nombre de la vista actual

        // ⚠️ CLAVES (DEBES USAR TUS CLAVES REALES AQUÍ)
        const SUPABASE_URL = 'https://nqdxsapbkkecckjehybx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5xZHhzYXBia2tlY2NramVoeWJ4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2MDIwMzYsImV4cCI6MjA3NjE3ODAzNn0.GvvYnAoerud9bzHlF4nvAVGRMhVhUtr25m4zrdrAnkk';
        let supabaseClient = null;

        // Variable para resultados de búsqueda de proveedores
        let providerResults = [];

        // ===================================================================
        // FUNCIONES DE INICIALIZACIÓN Y AUTHENTICACIÓN
        // ===================================================================

        function initializeSupabase() {
            if (typeof supabase?.createClient !== 'function') { // Chequeo más seguro
                console.error("Error: Librería de Supabase no cargada o inválida.");
                return false;
            }
            supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            return true;
        }

        // ===================================================================
        // FUNCIONES DE UTILIDAD (Dropdown)
        // ===================================================================
        // (Sin cambios aquí - toggleDropdown, closeAllDropdowns, listener de click)
        function toggleDropdown(id) {
            event.stopPropagation();
            const dropdown = document.getElementById(id);
            if (dropdown) {
                closeAllDropdowns(id);
                dropdown.classList.toggle('hidden');
            }
        }
        function closeAllDropdowns(exceptId = null) {
            const dropdowns = document.querySelectorAll('.dropdown-menu');
            dropdowns.forEach(dropdown => {
                if (dropdown.id !== exceptId && !dropdown.classList.contains('hidden')) {
                    dropdown.classList.add('hidden');
                }
            });
        }
        window.addEventListener('click', function(e) {
            if (!e.target.closest('.dropdown-toggle')) {
                closeAllDropdowns();
            }
        });
        // ==================================================================

        // ==================================================================
        // ✅ FUNCIÓN `setupAuthListener` (SIMPLIFICADA v4 para persistencia)
        // ==================================================================
        function setupAuthListener() {
            if (!supabaseClient) return;

            // Listener para CAMBIOS de estado (Login/Logout explícito)
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log("Auth state changed:", event); // Debug
                const previousUser = currentUser;
                currentUser = session ? session.user : null;

                // Actualiza el header solo si el usuario cambió
                if (currentUser?.id !== previousUser?.id) {
                    renderHeader();
                }

                // Navegación SOLO en eventos explícitos de login/logout
                if (event === 'SIGNED_IN' && !window.location.hash.includes('dashboard')) { // Evita doble redirect si ya está yendo
                    console.log("Event SIGNED_IN detected. Going to default dashboard.");
                    await new Promise(resolve => setTimeout(resolve, 50)); // Pequeña pausa
                    goToDashboard();
                } else if (event === 'SIGNED_OUT') {
                    console.log("Event SIGNED_OUT detected. Going home.");
                    providerResults = []; // Limpia resultados
                    setView('home'); // Asegura ir a home al desloguearse
                }
                // IMPORTANTE: IGNORAMOS 'INITIAL_SESSION' y 'TOKEN_REFRESHED' para navegación aquí.
                // 'window.onload' se encarga de la vista inicial.
                // Volver a la pestaña (TOKEN_REFRESHED) no debe cambiar la vista.
            });
        }

        async function handleLogout() {
            try {
                const { error } = await supabaseClient.auth.signOut();
                if (error) throw error;
                // onAuthStateChange se encargará de currentUser=null y setView('home')
                alert("Sesión cerrada correctamente.");
            } catch (error) {
                console.error('Error al cerrar sesión:', error.message);
                alert('Ocurrió un error al intentar cerrar la sesión.');
            }
        }
          // Función que determina el dashboard POR DEFECTO según rol
      function goToDashboard() {
           // Solo navega si no estamos ya en proceso
           if (isNavigating) return;
          if (currentUser) {
              const userRole = currentUser.user_metadata.user_role;
              if (userRole === 'proveedor') {
                  setView('dashboard_proveedor');
              } else if (userRole === 'productor') {
                  setView('categories_selection');
              } else {
                  console.warn("Usuario conectado pero sin rol. Yendo a home.");
                  setView('home');
              }
          } else {
              // Si no hay usuario, va a home (aunque no debería llamarse en este caso)
              setView('home');
          }
      }

// FUNCIÓN PARA EL BOTÓN 'PUBLICAR OFERTA' EN HOME
        function handlePublishOfferClick() {
            if (currentUser) {
                setView('add_offer');
            } else {
                setView('login');
            }
        }

// FUNCIÓN: Manejador de Búsqueda por Término (Desde Home)
        async function handleSearch() {
            const inputElement = document.getElementById('search-input');
            const searchTerm = inputElement ? inputElement.value : '';
            await loadProviderResults({ type: 'search', value: searchTerm });
        }

// FUNCIÓN: Manejador de Clic en Categoría
        async function handleCategoryClick(categoryName) {
            await loadProviderResults({ type: 'category', value: categoryName });
        }


        async function handleLogin(event) {
            event.preventDefault();
            if (!supabaseClient) return alert("Error de conexión a la BDD.");

            const form = event.target;
            const email = form.email.value;
            const password = form.password.value;

            try {
                const { data, error } = await supabaseClient.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) throw error;
                alert(`¡Inicio de sesión exitoso! Bienvenido, ${data.user.email}.`);
                // onAuthStateChange('SIGNED_IN') se encargará de la navegación

                } catch (error) {
                alert(`Error al iniciar sesión: ${error.message}`);
                console.error('Error en Supabase SignIn:', error);
            }
        }

        function updateRegisterForm(role) {
            selectedRole = role;
            setView('register');
        }

        // FUNCIÓN `handleRegister` (Corregida para Perfiles)
        async function handleRegister(event) {
            event.preventDefault();
            if (!supabaseClient) return alert("Error de conexión a la BDD.");

            const form = event.target;
            const email = form.email.value;
            const password = form.password.value;
            const roleToRegister = selectedRole || 'productor';

            const nombreCompleto = form.nombre ? form.nombre.value : null;
            const nombreEmpresa = form.empresa ? form.empresa.value : null;
            const displayName = nombreEmpresa || nombreCompleto;

            try {
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            user_role: roleToRegister,
                            display_name: displayName
                        }
                    }
                });

                if (authError) throw authError;

                const user = authData.user || authData.session?.user;
                if (!user) throw new Error("No se pudo crear el usuario.");

                if (roleToRegister === 'proveedor') {
                    // Lógica de Proveedor
                    const { error: dbError } = await supabaseClient
                        .from('proveedores')
                        .insert([
                            {
                                user_id: user.id,
                                nombre_empresa: nombreEmpresa,
                                cuit: form.cuit.value,
                                direccion: form.direccion.value,
                                email_contacto: email
                            }
                        ]);
                    if (dbError) throw dbError;

                } else if (roleToRegister === 'productor') {
                    // Lógica corregida para Productor
                    const { error: dbError } = await supabaseClient
                        .from('productores')
                        .insert([
                            {
                                user_id: user.id,
                                nombre_completo: nombreCompleto,
                                direccion: form.direccion.value,
                                dni: form.dni.value,
                                email: email
                            }
                        ]);
                    if (dbError) throw dbError;
                }

                alert("¡Registro exitoso! Revisa tu correo electrónico para confirmar tu cuenta y poder iniciar sesión. 📧");
                setView('login');

            } catch (error) {
                alert(`Error en el registro: ${error.message}`);
                console.error('Error en Supabase SignUp/Insert:', error);
            }
        }

        async function handleAddOffer(event) {
            event.preventDefault();
            if (!supabaseClient || !currentUser) return alert("Debes iniciar sesión para publicar ofertas.");
            const form = event.target;
            const offerData = { /*...*/ }; // (Sin cambios aquí)
            try { /*...*/ } catch (error) { /*...*/ }
        }

        // FUNCIÓN `handleProfileUpdate` (Corregida para Perfiles)
        async function handleProfileUpdate(event) {
            event.preventDefault();
             if (!supabaseClient || !currentUser) return alert("Debes iniciar sesión para actualizar tu perfil.");
             const form = event.target;
             const userRole = currentUser.user_metadata.user_role;
             const tableName = userRole === 'proveedor' ? 'proveedores' : 'productores';
             let updateData = {};
             const nuevoNombre = form.nombre_update.value;
             const nuevaDireccion = form.direccion_update.value;
             if (userRole === 'proveedor') { /*...*/ } else if (userRole === 'productor') { /*...*/ } // (Sin cambios aquí)
             try {
                const { error: dbError } = await supabaseClient.from(tableName).update(updateData).eq('user_id', currentUser.id);
                if (dbError) throw dbError;
                await supabaseClient.auth.updateUser({ data: { display_name: nuevoNombre } });
                if (currentUser?.user_metadata) currentUser.user_metadata.display_name = nuevoNombre;
                renderHeader();
                alert(`¡Perfil de ${userRole} actualizado con éxito!`);
                goToDashboard(); // Va al dashboard por defecto
            } catch (error) { /*...*/ }
        }


        // ===================================================================
        // FUNCIONES DE CARGA DE DATOS (GETTERS)
        // ===================================================================

        // FUNCIÓN `loadProviderResults` (Unificada: Búsqueda y Categoría - CORREGIDA v4)
        async function loadProviderResults(filter = {}) {
            if (!supabaseClient) return;
            providerResults = [];
            const { type, value } = filter;
            let navigateAfterLoad = !!(type && value); // Navega SI hay filtro
             console.log(`Loading providers. Filter type: ${type}, value: ${value}, navigate: ${navigateAfterLoad}`); // Debug

            try {
                let providerUserIds = [];
                // 1. Si hay filtro, busca IDs en OFERTAS
                if (type && value) {
                    let offersQuery = supabaseClient.from('ofertas').select('user_id');
                    if (type === 'search') offersQuery = offersQuery.or(`titulo.ilike.%${value}%,descripcion.ilike.%${value}%`);
                    else if (type === 'category') offersQuery = offersQuery.eq('categoria', value);
                    const { data: offers, error: offersError } = await offersQuery;
                    if (offersError) throw offersError;
                    if (!offers || offers.length === 0) {
                        console.log("No offers found for filter.");
                        providerResults = [];
                        if (navigateAfterLoad) setView('dashboard_productor'); // Muestra dashboard vacío
                        return;
                    }
                    providerUserIds = [...new Set(offers.map(o => o.user_id))];
                }

                // 2. Busca en PROVEEDORES
                let providersQuery = supabaseClient.from('proveedores').select('id, nombre_empresa, direccion, user_id');
                if (providerUserIds.length > 0) { // Filtra si se encontraron IDs
                    providersQuery = providersQuery.in('user_id', providerUserIds);
                } else if (type && value) {
                     // Si hubo filtro pero no se encontraron userIds, no hay resultados
                     console.log("Filter applied but no matching user IDs found in offers.");
                     providerResults = [];
                     if (navigateAfterLoad) setView('dashboard_productor');
                     return;
                }
                // Si no hubo filtro (type/value vacíos), trae todos.

                const { data: providers, error: providersError } = await providersQuery;
                if (providersError) throw providersError;
                providerResults = providers || [];
                console.log("Providers loaded:", providerResults.length);

                // 3. Navega/Renderiza
                if (navigateAfterLoad) {
                    setView('dashboard_productor'); // Navega al dashboard después de filtrar
                } else if (currentViewName === 'dashboard_productor') {
                     // Si ya estábamos en el dashboard (ej: carga inicial sin filtro), re-renderiza
                     console.log("Already on dashboard, re-rendering with new results.");
                     contentView.innerHTML = renderProducerDashboard();
                }

            } catch (error) {
                console.error('Error general en loadProviderResults:', error.message);
                providerResults = [];
                if (navigateAfterLoad || currentViewName === 'dashboard_productor') {
                    setView('dashboard_productor'); // Muestra dashboard vacío en caso de error
                }
            }
        }


        // FUNCIÓN `getProfileData` (Corregida para Perfiles)
        async function getProfileData(userId, role) {
             if (!supabaseClient || !userId) return null;
             try { /*...*/ } catch (e) { /*...*/ } // (Sin cambios aquí)
             return { /*...*/ };
        }


        // LÓGICA DE MAPAS (Corregida)
        function showProviderOnMap(address) {
             const iframe = document.getElementById('map-iframe');
             if (iframe && address) {
                 const encodedAddress = encodeURIComponent(address);
                 const mapUrl = `https://maps.google.com/maps?q=${encodedAddress}&output=embed&z=15`;
                 iframe.src = mapUrl;
             } else if (iframe) { // Si no hay address, muestra mapa general
                 iframe.src = `https://www.google.com/maps?q=Argentina&output=embed&z=5`;
             } else {
                 console.error("Error: No se encontró el iframe con id='map-iframe'.");
             }
        }

        // ===================================================================
        // FUNCIONES DE VISTA (RENDERIZADO)
        // ===================================================================

        // ==================================================================
        // ✅ FUNCIÓN `setView` (REFINADA v5 para persistencia y hashchange)
        // ==================================================================
        function setView(viewName, data = null) {
            // Previene navegación si ya se está navegando a la MISMA vista
            if (isNavigating && currentViewName === viewName && window.location.hash === `#${viewName}`) {
                 console.log(`Navigation blocked: already navigating to ${viewName}`);
                 return;
            }
             // Previene navegación si se está navegando a OTRA vista diferente
             if (isNavigating) {
                 console.log(`Navigation blocked: busy navigating to ${currentViewName}, ignoring request for ${viewName}`);
                 return;
             }

            console.log(`Setting view: ${viewName}`, data ? `with data: ${data}` : '');
            isNavigating = true; // Bloquea
            currentViewName = viewName; // Actualiza vista actual

            // Actualiza el hash SOLO si es diferente, previene loops con hashchange
            const newHash = viewName + (data ? `/${data}` : ''); // Incluye data en hash si existe
            if (window.location.hash !== `#${newHash}`) {
                 console.log("Updating hash to:", newHash);
                 window.location.hash = newHash;
            }

            // Define qué vistas son asíncronas
            const isAsyncView = ['profile_edit', 'my_products', 'edit_offer', 'provider_details'].includes(viewName);

            const releaseNavFlag = () => {
                // Pequeño retraso para asegurar que el hashchange no interfiera inmediatamente
                setTimeout(() => {
                    isNavigating = false;
                    console.log(`Navigation flag OFF for ${viewName}`);
                }, 100); // Aumentado ligeramente el retraso
            };

            if (isAsyncView) {
                contentView.innerHTML = `<div class="text-center p-10 text-accent-cyan font-heading">Cargando datos...</div>`;
                const renderPromise = viewName === 'profile_edit' ? renderProfileEditView() :
                                      viewName === 'my_products' ? renderMyProductsView() :
                                      viewName === 'edit_offer' ? renderEditOfferView(data) :
                                      renderProviderDetailsView(data);

                renderPromise.then(html => {
                     console.log(`Async render complete for: ${viewName}`);
                    // Renderiza solo si la vista actual sigue siendo la misma que se pidió
                    if (currentViewName === viewName) {
                        contentView.innerHTML = html;
                    } else {
                         console.log(`View changed during async load (${currentViewName}), aborting render for: ${viewName}`);
                    }
                    releaseNavFlag();
                }).catch(error => {
                    console.error(`Error rendering async view: ${viewName}`, error);
                    if (currentViewName === viewName) { // Muestra error solo si la vista no cambió
                       contentView.innerHTML = `<p class="text-red-500 font-sans">Error al cargar la vista: ${error.message}</p>`;
                    }
                     releaseNavFlag();
                });
                return; // Importante salir para vistas asíncronas
            }

            // Para vistas síncronas
             try {
                 console.log(`Rendering sync view: ${viewName}`);
                contentView.innerHTML = renderView(viewName, data);
            } catch (error) {
                 console.error(`Error rendering sync view: ${viewName}`, error);
                 contentView.innerHTML = `<p class="text-red-500 font-sans">Error al mostrar la vista: ${error.message}</p>`;
            }
             releaseNavFlag();
        }


        function renderView(viewName, data) {
             console.log("RenderView called for:", viewName);
            switch (viewName) {
                case 'home': return renderHomeView();
                case 'login': return renderLoginView();
                case 'register': return renderRegisterView();
                case 'categories_selection': return renderCategoriesSelectionView();
                case 'dashboard_productor': return renderProducerDashboard();
                case 'dashboard_proveedor': return renderProviderDashboard();
                case 'provider_details': return renderProviderDetailsView(data); // Data es el ID
                case 'info': return renderInfoView(data);
                case 'add_offer': return renderAddOfferView();
                case 'como_funciona': return renderComoFuncionaView();
                default:
                    console.warn("Unknown view name in renderView, rendering home:", viewName);
                    return renderHomeView(); // Fallback a home
            }
        }

        // VISTA: Selección de Categorías
        function renderCategoriesSelectionView() { /*...*/ } // Sin cambios

        // VISTA: Editar Perfil
        async function renderProfileEditView() { /*...*/ } // Sin cambios (ya usaba goToDashboard)

        // VISTA: Mis Productos (Proveedor)
        async function renderMyProductsView() { /*...*/ } // Sin cambios

        // Lógica: Eliminar Oferta
        async function handleRemoveOffer(offerId) { /*...*/ } // Sin cambios

        // Lógica: Actualizar Oferta
        async function handleUpdateOffer(event, offerId) { /*...*/ } // Sin cambios

        // VISTA: Editar Oferta
        async function renderEditOfferView(offerId) { /*...*/ } // Sin cambios

        // Render Header
        function renderHeader() { /*...*/ } // (Sin cambios, logo ya iba a home)

        // VISTA: Home
        function renderHomeView() { /*...*/ } // (Sin cambios, botones ya estaban bien)

        // VISTA: Login
        function renderLoginView() { /*...*/ } // Sin cambios

        // VISTA: Registro (Selección Rol)
        function renderRegisterView() { /*...*/ } // Sin cambios

        // Formularios Registro Productor/Proveedor
        function renderProductorForm() { /*...*/ } // Sin cambios
        function renderProveedorForm() { /*...*/ } // Sin cambios

        // Auxiliar: Render Rating
        function renderRating() { /*...*/ } // Sin cambios

        // VISTA: Dashboard Productor (Resultados Búsqueda)
        function renderProducerDashboard() { /*...*/ } // Sin cambios (ya usaba providerResults)

        // VISTA: Dashboard Proveedor
        function renderProviderDashboard() { /*...*/ } // Sin cambios

        // VISTA: Detalles Proveedor
        async function renderProviderDetailsView(providerId) { /*...*/ } // Sin cambios (ya era async)

        // VISTA: Info genérica
        function renderInfoView(title) { /*...*/ } // Sin cambios

        // VISTA: Cómo Funciona
        function renderComoFuncionaView() { /*...*/ } // Sin cambios

        // VISTA: Añadir Oferta (Proveedor)
        function renderAddOfferView() { /*...*/ } // Sin cambios


        // ===================================================================
        // ✅ PUNTO DE ARRANQUE DE LA APLICACIÓN (REFINADO v3)
        // ===================================================================
        window.onload = () => {
             console.log("Window onload."); // Debug
            if (initializeSupabase()) {
                setupAuthListener(); // Se encarga de la sesión inicial Y la vista inicial
                // loadProviderResults(); // No cargar aquí, se carga bajo demanda o en handleInitialView si es necesario
            } else {
                 contentView.innerHTML = `<p class="text-red-500 p-8 text-center">Error al conectar con la base de datos.</p>`;
                 // Forzar render home si Supabase falla catastróficamente
                 currentViewName = 'home';
                 contentView.innerHTML = renderHomeView();
                 renderHeader(); // Render header básico sin usuario
            }

            // LISTENER `hashchange` (Simplificado)
            window.addEventListener('hashchange', () => {
                 console.log("Hashchange event listener fired. Current hash:", window.location.hash, "isNavigating:", isNavigating); // Debug
                // Solo reacciona si NO estamos navegando programáticamente
                 if (!isNavigating) {
                    console.log("Hashchange processing (triggered by browser back/forward)."); // Debug
                    const newHash = window.location.hash.replace('#', '');
                    const parts = newHash.split('/');
                    const viewName = parts[0] || 'home'; // Vista base, o home si está vacío
                    const data = parts.length > 1 ? parts[1] : null; // Data si existe

                    // Llama a setView para actualizar el contenido según el nuevo hash
                    setView(viewName, data);
                } else {
                     console.log("Hashchange ignored (navigation flag is ON)."); // Debug
                }
            });

             // Render inicial del Header (será actualizado por setupAuthListener si hay sesión)
             if (!currentUser) {
                 renderHeader();
             }
        };

    </script>
</body>
</html>


